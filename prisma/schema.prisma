generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")

}

model User {
  id                     Int            @id @default(autoincrement())
  email                  String         @unique
  password               String
  role                   Role           @default(CANDIDATE)
  status                 UserStatus     @default(ACTIVE)
  tenantId               Int?           @map("tenant_id")
  verified               Boolean        @default(false)
  emailVerificationToken String?        @map("email_verification_token")
  passwordResetToken     String?        @map("password_reset_token")
  passwordResetExpiry    DateTime?      @map("password_reset_expiry")
  lastLoginAt            DateTime?      @map("last_login_at")
  deletedAt              DateTime?      @map("deleted_at")
  deletedBy              Int?           @map("deleted_by")
  createdAt              DateTime       @default(now()) @map("created_at")
  updatedAt              DateTime       @updatedAt @map("updated_at")
  applications           Application[]
  auditLogs              AuditLog[]
  sentMessages           Message[]      @relation("SentMessages")
  receivedMessages       Message[]      @relation("ReceivedMessages")
  profile                Profile?
  subscription           Subscription?
  userOrgRoles           UserOrgRole[]
  deletedByUser          User?          @relation("DeletedBy", fields: [deletedBy], references: [id])
  deletedUsers           User[]         @relation("DeletedBy")
  organization           Organization?  @relation(fields: [tenantId], references: [id])
  verifications          Verification[]
  createdJobs            Job[]          @relation("JobCreator")
  changedJobVersions     JobVersion[]   @relation("JobVersionChanger")

  @@index([role])
  @@index([tenantId])
  @@index([status])
  @@index([deletedAt])
  @@index([lastLoginAt])
  @@map("users")
}

model Organization {
  id               Int              @id @default(autoincrement())
  name             String           @unique
  plan             OrgPlan          @default(INDIVIDUAL)
  verified         Boolean          @default(false)
  stripeCustomerId String?          @map("stripe_customer_id")
  createdAt        DateTime         @default(now()) @map("created_at")
  updatedAt        DateTime         @updatedAt @map("updated_at")
  domain           String?
  jobs             Job[]
  subscription     OrgSubscription?
  userOrgRoles     UserOrgRole[]
  users            User[]
  verifications    Verification[]

  @@map("organizations")
}

model UserOrgRole {
  id           Int          @id @default(autoincrement())
  userId       Int          @map("user_id")
  orgId        Int          @map("org_id")
  role         Role
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, orgId])
  @@map("user_org_roles")
}

model Profile {
  id                  Int              @id @default(autoincrement())
  userId              Int              @unique @map("user_id")
  firstName           String           @map("first_name")
  lastName            String           @map("last_name")
  phone               String?
  location            String?
  resumeUrl           String?          @map("resume_url")
  skills              Json?
  experience          Json?
  preferences         Json?
  summary             String?
  linkedinUrl         String?          @map("linkedin_url")
  githubUrl           String?          @map("github_url")
  websiteUrl          String?          @map("website_url")
  createdAt           DateTime         @default(now()) @map("created_at")
  updatedAt           DateTime         @updatedAt @map("updated_at")
  bio                 String?
  headline            String?
  privacyMode         PrivacyMode      @default(PUBLIC) @map("privacy_mode")
  profileCompleteness Int              @default(0) @map("profile_completeness")
  embeddingsGenerated Boolean          @default(false) @map("embeddings_generated")
  embeddingsVersion   Int?             @map("embeddings_version")
  profilePhotoUrl     String?          @map("profilephotourl")
  educations          Education[]
  profileSkills       ProfileSkill[]
  user                User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  resumes             Resume[]
  workExperiences     WorkExperience[]

  @@map("profiles")
}

model Subscription {
  id                   Int              @id @default(autoincrement())
  userId               Int              @unique @map("user_id")
  tier                 SubscriptionTier @default(FREE)
  status               String           @default("active")
  stripeCustomerId     String?          @map("stripe_customer_id")
  stripeSubscriptionId String?          @map("stripe_subscription_id")
  currentPeriodStart   DateTime?        @map("current_period_start")
  currentPeriodEnd     DateTime?        @map("current_period_end")
  createdAt            DateTime         @default(now()) @map("created_at")
  updatedAt            DateTime         @updatedAt @map("updated_at")
  user                 User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("subscriptions")
}

model OrgSubscription {
  id                   Int          @id @default(autoincrement())
  orgId                Int          @unique @map("org_id")
  plan                 OrgPlan
  status               String       @default("active")
  stripeCustomerId     String?      @map("stripe_customer_id")
  stripeSubscriptionId String?      @map("stripe_subscription_id")
  currentPeriodStart   DateTime?    @map("current_period_start")
  currentPeriodEnd     DateTime?    @map("current_period_end")
  createdAt            DateTime     @default(now()) @map("created_at")
  updatedAt            DateTime     @updatedAt @map("updated_at")
  organization         Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@map("org_subscriptions")
}

// ============================================
// JOB MODEL (Enhanced)
// ============================================

model Job {
  id                  Int           @id @default(autoincrement())
  title               String
  description         String
  
  // DEPRECATED: Keep for backward compatibility, but use JobRequiredSkill instead
  requirements        Json?         // Will be migrated to JobRequiredSkill
  
  // Location & Work Mode
  location            String?
  remote              Boolean       @default(false)
  hybrid              Boolean       @default(false)
  
  // Compensation
  salaryMin           Int?          @map("salary_min")
  salaryMax           Int?          @map("salary_max")
  currency            String?       @default("USD")
  
  // Job Classification
  type                JobType       @default(FULL_TIME)
  status              JobStatus     @default(ACTIVE)
  roleType            RoleType      @default(INDIVIDUAL_CONTRIBUTOR) @map("role_type")
  seniorityLevel      SeniorityLevel @default(MID_LEVEL) @map("seniority_level")
  department          String?       // Engineering, Sales, Marketing, etc.
  
  // Experience Requirements
  minExperience       Int?          @map("min_experience")  // Years
  maxExperience       Int?          @map("max_experience")  // Years
  
  // Organization
  orgId               Int           @map("org_id")
  createdBy           Int           @map("created_by")
  
  // Lifecycle
  expiresAt           DateTime?     @map("expires_at")
  publishedAt         DateTime?     @map("published_at")
  closedAt            DateTime?     @map("closed_at")
  filledAt            DateTime?     @map("filled_at")
  
  // Quality & Analytics
  qualityScore        Float?        @map("quality_score")
  viewCount           Int           @default(0) @map("view_count")
  applicationCount    Int           @default(0) @map("application_count")
  
  // DEPRECATED: Old single embedding approach
  embeddings          Json?
  embeddingsGenerated Boolean       @default(false) @map("embeddings_generated")
  embeddingsVersion   Int?          @map("embeddings_version")
  
  // Timestamps
  createdAt           DateTime      @default(now()) @map("created_at")
  updatedAt           DateTime      @updatedAt @map("updated_at")
  
  // Relations
  applications        Application[]
  jobVersions         JobVersion[]
  organization        Organization  @relation(fields: [orgId], references: [id])
  creator             User          @relation("JobCreator", fields: [createdBy], references: [id])
  
  // Multi-vector embeddings (replaces embeddings field)
  jobEmbeddings       JobEmbedding[]
  
  // Structured skill requirements (replaces requirements JSON)
  requiredSkills      JobRequiredSkill[]
  
  @@index([orgId])
  @@index([status])
  @@index([type])
  @@index([roleType])
  @@index([seniorityLevel])
  @@index([createdBy])
  @@index([publishedAt])
  @@index([expiresAt])
  @@map("jobs")
}


// ============================================
// JOB REQUIRED SKILLS
// ============================================

model JobRequiredSkill {
  id                  Int       @id @default(autoincrement())
  jobId               Int       @map("job_id")
  skillTaxonomyId     Int       @map("skill_taxonomy_id")
  
  // ✅ Context & requirements
  importance          SkillImportance @default(REQUIRED)
  weight              Float     @default(1.0)  // 0.5-2.0 for this specific job
  
  yearsRequired       Int?      @map("years_required")
  proficiencyRequired ProficiencyLevel? @map("proficiency_required")
  
  // ✅ Extraction metadata
  source              String    @default("JD_PARSING")  // JD_PARSING, MANUAL, AI_ENHANCED
  confidence          Float     @default(0.9)
  contextSnippet      String?   @map("context_snippet")  // NEW: Where in JD was this found
  
  // ✅ Analytics
  matchCount          Int       @default(0) @map("match_count")  // Candidate match count
  avgCandidateYears   Float?    @map("avg_candidate_years")  // NEW: Benchmark data
  
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")
  
  job                 Job       @relation(fields: [jobId], references: [id], onDelete: Cascade)
  skillTaxonomy       SkillTaxonomy @relation(fields: [skillTaxonomyId], references: [id])
  
  @@unique([jobId, skillTaxonomyId])
  @@index([jobId])
  @@index([skillTaxonomyId])
  @@index([importance])
  @@index([confidence])  // NEW: Filter low-confidence skills
  @@map("job_required_skills")
}



// ============================================
// JOB VERSION 
// ============================================

model JobVersion {
  id         Int      @id @default(autoincrement())
  jobId      Int      @map("job_id")
  version    Int      @default(1)
  
  // ✅ Enhanced snapshot
  jdSnapshot Json     @map("jd_snapshot")  // Complete job data at this version
  
  // ✅ Change tracking
  changedBy  Int?     @map("changed_by")
  changeType String?  @map("change_type")  // CREATED, UPDATED, REPUBLISHED, CLOSED
  changeNote String?  @map("change_note")   // Why was it changed
  
  // ✅ DEPRECATED: Use JobEmbedding instead
  embeddings Json?
  
  createdAt  DateTime @default(now()) @map("created_at")
  
  job        Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  changer    User?    @relation("JobVersionChanger", fields: [changedBy], references: [id])

  @@unique([jobId, version])
  @@index([jobId])
  @@map("job_versions")
}
model Application {
  id                 Int                   @id @default(autoincrement())
  candidateId        Int                   @map("candidate_id")
  jobId              Int                   @map("job_id")
  status             ApplicationStatus     @default(SUBMITTED)
  privacyMode        PrivacyMode           @default(PUBLIC)
  coverLetter        String?               @map("cover_letter")
  resumeSnapshot     Json?                 @map("resume_snapshot")
  matchScore         Float?                @map("match_score")
  explanationPayload Json?                 @map("explanation_payload")
  slaTimers          Json?                 @map("sla_timers")
  appliedAt          DateTime              @default(now()) @map("applied_at")
  updatedAt          DateTime              @updatedAt @map("updated_at")
  feedback           ApplicationFeedback[]
  stages             ApplicationStage[]
  candidate          User                  @relation(fields: [candidateId], references: [id])
  job                Job                   @relation(fields: [jobId], references: [id])
  interviews         Interview[]

  @@unique([candidateId, jobId])
  @@map("applications")
}

model ApplicationStage {
  id            Int               @id @default(autoincrement())
  applicationId Int               @map("application_id")
  stage         ApplicationStatus
  notes         String?
  movedAt       DateTime          @default(now()) @map("moved_at")
  movedBy       Int?              @map("moved_by")
  application   Application       @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  @@map("application_stages")
}

model ApplicationFeedback {
  id            Int         @id @default(autoincrement())
  applicationId Int         @map("application_id")
  rating        Int?
  feedback      String?
  isPublic      Boolean     @default(false) @map("is_public")
  createdAt     DateTime    @default(now()) @map("created_at")
  application   Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  @@map("application_feedback")
}

model Interview {
  id            Int         @id @default(autoincrement())
  applicationId Int         @map("application_id")
  scheduledAt   DateTime    @map("scheduled_at")
  duration      Int?
  meetingLink   String?     @map("meeting_link")
  status        String      @default("SCHEDULED")
  notes         String?
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")
  application   Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  @@map("interviews")
}

model Message {
  id       Int      @id @default(autoincrement())
  fromId   Int      @map("from_id")
  toId     Int      @map("to_id")
  threadId String?  @map("thread_id")
  subject  String?
  content  String
  isRead   Boolean  @default(false) @map("is_read")
  sentAt   DateTime @default(now()) @map("sent_at")
  sender   User     @relation("SentMessages", fields: [fromId], references: [id])
  receiver User     @relation("ReceivedMessages", fields: [toId], references: [id])

  @@map("messages")
}

model Verification {
  id           Int                @id @default(autoincrement())
  userId       Int?               @map("user_id")
  orgId        Int?               @map("org_id")
  type         String
  status       VerificationStatus @default(PENDING)
  documents    Json?
  notes        String?
  reviewedBy   Int?               @map("reviewed_by")
  reviewedAt   DateTime?          @map("reviewed_at")
  createdAt    DateTime           @default(now()) @map("created_at")
  updatedAt    DateTime           @updatedAt @map("updated_at")
  organization Organization?      @relation(fields: [orgId], references: [id])
  user         User?              @relation(fields: [userId], references: [id])

  @@map("verifications")
}

model AuditLog {
  id         Int      @id @default(autoincrement())
  userId     Int?     @map("user_id")
  action     String
  resource   String?
  resourceId Int?     @map("resource_id")
  metadata   Json?
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")
  timestamp  DateTime @default(now())
  user       User?    @relation(fields: [userId], references: [id])

  @@map("audit_logs")
}


model Resume {
  id              Int              @id @default(autoincrement())
  profileId       Int              @map("profile_id")
  filename        String
  originalName    String           @map("original_name")
  filePath        String           @map("file_path")
  fileSize        Int              @map("file_size")
  mimetype        String
  parseStatus     ParseStatus      @default(PENDING) @map("parse_status")
  confidenceScore Float?           @map("confidence_score")
  isPrimary       Boolean          @default(false) @map("is_primary")
  parsedData      Json?            @map("parsed_data")
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")
  critiques       ResumeCritique[]
  profile         Profile          @relation(fields: [profileId], references: [id], onDelete: Cascade)
  workExperiences WorkExperience[]
  educations      Education[]

  @@index([profileId, isPrimary])
  @@index([parseStatus])
  @@map("resumes")
}

model ResumeCritique {
  id           Int      @id @default(autoincrement())
  resumeId     Int      @map("resume_id")
  overallScore Int      @map("overall_score")
  sections     Json
  suggestions  Json
  strengths    Json
  weaknesses   Json
  aiModel      String   @map("ai_model")
  createdAt    DateTime @default(now()) @map("created_at")
  resume       Resume   @relation(fields: [resumeId], references: [id], onDelete: Cascade)

  @@map("resume_critiques")
}

model ProfileSkill {
  id               Int               @id @default(autoincrement())
  profileId        Int               @map("profile_id")
  
  // ✅ Taxonomy linkage
  skillTaxonomyId  Int?              @map("skill_taxonomy_id")
  skillTaxonomy    SkillTaxonomy?    @relation(fields: [skillTaxonomyId], references: [id])
  
  // ✅ Legacy support
  skillName        String            @map("skill_name")
  
  category         String?
  proficiencyLevel ProficiencyLevel? @map("proficiency_level")
  yearsExperience  Int?              @map("years_experience")
  
  // ✅ Verification & endorsements
  source           SkillSource       @default(AI_EXTRACTED)
  verified         Boolean           @default(false)
  endorsementCount Int               @default(0) @map("endorsement_count")  // NEW: LinkedIn-style
  lastUsedAt       DateTime?         @map("last_used_at")  // NEW: Skill recency
  
  skillType        SkillType         @default(TECHNICAL) @map("skill_type")
  
  createdAt        DateTime          @default(now()) @map("created_at")
  updatedAt        DateTime          @updatedAt @map("updated_at")
  
  profile          Profile           @relation(fields: [profileId], references: [id], onDelete: Cascade)
  endorsements     SkillEndorsement[]  // NEW: Track endorsers
  
  @@unique([profileId, skillName])
  @@index([profileId])
  @@index([skillTaxonomyId])
  @@index([verified])  // NEW: Prioritize verified skills
  @@index([lastUsedAt])  // NEW: Skill decay/freshness
  @@map("profile_skills")
}

model SkillEndorsement {
  id             Int      @id @default(autoincrement())
  profileSkillId Int      @map("profile_skill_id")
  endorsedBy     Int?     @map("endorsed_by")  // User ID (nullable for AI endorsements)
  endorserType   String   @default("USER")  // USER, AI, CERTIFICATION
  createdAt      DateTime @default(now()) @map("created_at")
  
  profileSkill   ProfileSkill @relation(fields: [profileSkillId], references: [id], onDelete: Cascade)
  
  @@unique([profileSkillId, endorsedBy])
  @@index([profileSkillId])
  @@map("skill_endorsements")
}


// ============================================
// Multi-Vector Embedding Models
// ============================================

model CandidateEmbedding {
  id          Int      @id @default(autoincrement())
  candidateId Int      @map("candidate_id")
  type        String   // summary, skills, experience, education, full, job_specific
  jobId       Int?     @map("job_id")  // For job-specific candidate embeddings
  vector      Unsupported("vector")?
  dimension   Int
  modelName   String   @map("model_name")
  version     Int      @default(1)
  
  // ✅ Metadata
  tokenCount  Int?     @map("token_count")
  language    String?  @default("en")
  
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@unique([candidateId, type, jobId, version])  // NEW
  @@index([candidateId])
  @@index([type])
  @@index([jobId])
  @@index([version])
  @@map("candidate_embeddings")
}


// ============================================
// JOB EMBEDDINGS (Enhanced for Multi-Vector)
// ============================================

model JobEmbedding {
  id          Int      @id @default(autoincrement())
  jobId       Int      @map("job_id")
  type        String   // jd_summary, required_skills, responsibilities, culture, benefits, full
  vector      Unsupported("vector")?
  dimension   Int
  modelName   String   @map("model_name")
  version     Int      @default(1)
  
  // ✅ Metadata
  tokenCount  Int?     @map("token_count")  // NEW: For chunking strategies
  language    String?  @default("en")  // NEW: Multilingual support
  
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  job         Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@unique([jobId, type, version])  // NEW: Prevent duplicate embeddings
  @@index([jobId])
  @@index([type])
  @@index([version])  // NEW: Query latest version
  @@map("job_embeddings")
}



model WorkExperience {
  id           Int       @id @default(autoincrement())
  profileId    Int       @map("profile_id")
  company      String
  position     String
  location     String?
  startDate    DateTime? @map("start_date")
  endDate      DateTime? @map("end_date")
  isCurrent    Boolean   @default(false) @map("is_current")
  description  String?
  achievements Json?
  skills       Json?
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  profile      Profile   @relation(fields: [profileId], references: [id], onDelete: Cascade)
  resumeId    Int?      @map("resume_id")  // Track source resume
  source      String    @default("AI_EXTRACTED") // MANUAL, AI_EXTRACTED, VERIFIED
  resume      Resume?   @relation(fields: [resumeId], references: [id])

  @@index([resumeId])
  @@map("work_experiences")
}

model Education {
  id          Int       @id @default(autoincrement())
  profileId   Int       @map("profile_id")
  institution String
  degree      String
  field       String?
  startDate   DateTime? @map("start_date")
  endDate     DateTime? @map("end_date")
  grade       String?
  description String?
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  profile     Profile   @relation(fields: [profileId], references: [id], onDelete: Cascade)
  resumeId    Int?      @map("resume_id")  // Track source resume  
  source      String    @default("AI_EXTRACTED") // MANUAL, AI_EXTRACTED, VERIFIED

  resume      Resume?   @relation(fields: [resumeId], references: [id])

  @@index([resumeId])
  @@map("educations")
}

// ============================================
// SkillTaxonomy with Job Relations
// ============================================

model SkillTaxonomy {
  id                   Int      @id @default(autoincrement())
  
  // ✅ Core identifiers
  skillName            String   @map("skill_name")
  normalizedName       String   @unique @map("normalized_name")
  skillCode            String?  @unique @map("skill_code")  // NEW: Internal unique code (e.g., SKL-00123)
  
  // ✅ Classification
  skillType            SkillType @default(TECHNICAL) @map("skill_type")
  category             String?   // Frontend, Backend, Leadership, etc.
  subcategory          String?   // NEW: Finer granularity (e.g., Frontend > React)
  
  // ✅ Multi-level hierarchy (adjacency list + materialized path)
  parentId             Int?      @map("parent_id")
  parent               SkillTaxonomy? @relation("SkillHierarchy", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  children             SkillTaxonomy[] @relation("SkillHierarchy")
  
  skillLevel           Int       @map("skill_level")  // 0 = root, 1 = top-level, 2+ = sub-skills
  hierarchyPath        String?   @map("hierarchy_path")  // NEW: Materialized path (e.g., "/1/5/23/")
  
  // ✅ International ontology mappings
  escoUri              String?   @unique @map("esco_uri")  // NEW: e.g., http://data.europa.eu/esco/skill/abc123
  onetCode             String?   @map("onet_code")  // NEW: e.g., 2.B.4.a (can be non-unique)
  iscoCode             String?   @map("isco_code")  // NEW: International Standard Classification of Occupations
  
  // ✅ Role-based weighting (context-aware scoring)
  baseWeight           Float     @default(0.5) @map("base_weight")
  technicalRoleWeight  Float     @default(0.8) @map("technical_role_weight")
  leadershipRoleWeight Float     @default(0.6) @map("leadership_role_weight")
  managerialRoleWeight Float     @default(0.7) @map("managerial_role_weight")  // NEW
  
  // ✅ Demand & trend metrics
  demandScore          Float?    @default(0.5) @map("demand_score")  // NEW: 0-1 market demand
  trendingScore        Float?    @default(0.0) @map("trending_score")  // NEW: Growth velocity
  lastTrendUpdate      DateTime? @map("last_trend_update")  // NEW
  
  // ✅ Versioned embeddings (for semantic search)
  embeddingVersion     Int       @default(1) @map("embedding_version")  // NEW: Track embedding model version
  embedding            Unsupported("vector")?
  embeddingModel       String?   @map("embedding_model")
  embeddingDimension   Int?      @default(768) @map("embedding_dimension")
  embeddingUpdatedAt   DateTime? @map("embedding_updated_at")
  needsEmbeddingUpdate Boolean   @default(false) @map("needs_embedding_update")
  
  // ✅ Lifecycle & metadata
  status               SkillStatus @default(ACTIVE) @map("status")  // NEW: ACTIVE, DEPRECATED, MERGED
  mergedIntoId         Int?      @map("merged_into_id")  // NEW: If skill was merged
  mergedInto           SkillTaxonomy? @relation("SkillMerge", fields: [mergedIntoId], references: [id], onDelete: SetNull, onUpdate: NoAction)
  mergedSkills         SkillTaxonomy[] @relation("SkillMerge")
  
  industryRelevance    Json?     @map("industry_relevance")  // {"tech": 0.9, "healthcare": 0.3}
  roleRelevance        Json?     @map("role_relevance")      // {"engineer": 0.95, "designer": 0.4}
  
  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")
  
  // Relations
  profileSkills        ProfileSkill[]
  jobRequiredSkills    JobRequiredSkill[]
  
  synonyms             SkillSynonym[]  // NEW: Normalized relation
  relatedSkills        SkillRelation[] @relation("SourceSkill")  // NEW: Graph edges
  relatedBySkills      SkillRelation[] @relation("TargetSkill")  // NEW
  clusterMemberships   SkillClusterMember[]  // NEW: Many-to-many with clusters
  
  @@index([normalizedName])
  @@index([skillLevel])
  @@index([parentId])
  @@index([skillType])
  @@index([category])
  @@index([status])
  @@index([hierarchyPath])  // NEW: Fast hierarchy queries
  @@index([escoUri])  // NEW
  @@index([onetCode])  // NEW
  @@index([demandScore])  // NEW: For trending skills queries
  @@map("skill_taxonomy")
}

enum SkillStatus {
  ACTIVE
  DEPRECATED
  MERGED
  PENDING_REVIEW
}


enum SkillType {
  TECHNICAL
  SOFT
  DOMAIN
  TOOL
  CERTIFICATION
  LANGUAGE
}


model SkillSynonym {
  id               Int      @id @default(autoincrement())
  skillTaxonomyId  Int      @map("skill_taxonomy_id")
  synonym          String
  normalizedForm   String   @map("normalized_form")  // Lowercased, trimmed
  locale           String?  @default("en")  // NEW: Language support (en, es, fr, etc.)
  confidence       Float    @default(1.0)  // NEW: AI-extracted synonyms may have < 1.0
  source           String   @default("MANUAL")  // MANUAL, AI_EXTRACTED, ESCO, ONET
  
  createdAt        DateTime @default(now()) @map("created_at")
  
  skillTaxonomy    SkillTaxonomy @relation(fields: [skillTaxonomyId], references: [id], onDelete: Cascade)
  
  @@unique([skillTaxonomyId, normalizedForm])
  @@index([normalizedForm])  // Critical for Boolean search
  @@index([skillTaxonomyId])
  @@map("skill_synonyms")
}

model SkillRelation {
  id              Int      @id @default(autoincrement())
  sourceSkillId   Int      @map("source_skill_id")
  targetSkillId   Int      @map("target_skill_id")
  relationType    SkillRelationType @map("relation_type")
  strength        Float    @default(0.5)  // 0-1 relationship strength
  bidirectional   Boolean  @default(false)  // Is the relation symmetric?
  
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  sourceSkill     SkillTaxonomy @relation("SourceSkill", fields: [sourceSkillId], references: [id], onDelete: Cascade)
  targetSkill     SkillTaxonomy @relation("TargetSkill", fields: [targetSkillId], references: [id], onDelete: Cascade)
  
  @@unique([sourceSkillId, targetSkillId, relationType])
  @@index([sourceSkillId])
  @@index([targetSkillId])
  @@index([relationType])
  @@index([strength])  // For "show strongest related skills"
  @@map("skill_relations")
}

enum SkillRelationType {
  REQUIRES           // A requires B (e.g., React requires JavaScript)
  ENABLES            // A enables B (e.g., Python enables Django)
  SIMILAR_TO         // Synonymous/interchangeable
  SPECIALIZATION_OF  // A is a specialization of B
  COMMONLY_WITH      // Co-occurrence (data-driven)
  PROGRESSION        // Career progression path
}

model SkillCluster {
  id            Int      @id @default(autoincrement())
  clusterName   String   @unique @map("cluster_name")
  description   String?
  clusterType   String   @default("THEMATIC") @map("cluster_type")  // THEMATIC, ROLE_BASED, INDUSTRY_BASED
  
  // ✅ Cluster-level embedding (for semantic matching)
  embedding     Unsupported("vector")?
  embeddingModel String? @map("embedding_model")
  embeddingVersion Int   @default(1) @map("embedding_version")
  
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @default(now()) @updatedAt @map("updated_at")  
  
  members       SkillClusterMember[]
  
  @@index([clusterType])
  @@map("skill_clusters")
}

model SkillClusterMember {
  id              Int      @id @default(autoincrement())
  clusterId       Int      @map("cluster_id")
  skillTaxonomyId Int      @map("skill_taxonomy_id")
  weight          Float    @default(1.0)  // Importance within cluster
  isCoreSkill     Boolean  @default(false) @map("is_core_skill")  // Is this a defining skill?
  
  cluster         SkillCluster @relation(fields: [clusterId], references: [id], onDelete: Cascade)
  skill           SkillTaxonomy @relation(fields: [skillTaxonomyId], references: [id], onDelete: Cascade)
  
  @@unique([clusterId, skillTaxonomyId])
  @@index([clusterId])
  @@index([skillTaxonomyId])
  @@map("skill_cluster_members")
}

model SkillOntologyVersion {
  id              Int      @id @default(autoincrement())
  version         String   @unique  // e.g., "2025.11.1"
  escoVersion     String?  @map("esco_version")  // e.g., "v1.2.0"
  onetVersion     String?  @map("onet_version")  // e.g., "28.0"
  description     String?
  skillCount      Int      @map("skill_count")
  releasedAt      DateTime @map("released_at")
  isActive        Boolean  @default(false) @map("is_active")  // Only one active version
  
  createdAt       DateTime @default(now()) @map("created_at")
  
  @@index([isActive])
  @@map("skill_ontology_versions")
}


model NonTaxonomySkill {
  id             Int      @id @default(autoincrement())
  skillName      String   @map("skill_name")
  normalizedName String   @map("normalized_name")
  source         String   // RESUME, PROFILE, JOB_POSTING
  sourceId       Int?     @map("source_id") // Reference to the source entity
  frequency      Int      @default(1) // How many times encountered
  reviewed       Boolean  @default(false) // Has been reviewed for taxonomy inclusion
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  @@unique([normalizedName, source, sourceId])
  @@index([normalizedName])
  @@index([reviewed])
  @@map("non_taxonomy_skills")
}


enum Role {
  CANDIDATE
  RECRUITER
  ORG_ADMIN
  ORG_MANAGER
  ORG_RECRUITER
  PLATFORM_ADMIN
}

enum SubscriptionTier {
  FREE
  BASIC
  PREMIUM
}

enum OrgPlan {
  INDIVIDUAL
  ORG_BASIC
  ORG_PREMIUM
}

enum ApplicationStatus {
  SUBMITTED
  VIEWED
  SHORTLISTED
  INTERVIEW_SCHEDULED
  REJECTED
  OFFERED
  ACCEPTED
  WITHDRAWN
}

enum PrivacyMode {
  PUBLIC
  LIMITED
  ANONYMOUS
}

enum VerificationStatus {
  PENDING
  VERIFIED
  REJECTED
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  DELETED
}

enum ParseStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum SkillSource {
  MANUAL
  AI_EXTRACTED
  VERIFIED
}

enum ProficiencyLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  EXPERT
}



// ============================================
// JOB
// ============================================

enum JobStatus {
  DRAFT
  ACTIVE
  PAUSED
  CLOSED
  FILLED
  EXPIRED
  ARCHIVED
}

enum JobType {
  FULL_TIME
  PART_TIME
  CONTRACT
  FREELANCE
  INTERNSHIP
  TEMPORARY
}

enum RoleType {
  INDIVIDUAL_CONTRIBUTOR
  TEAM_LEAD
  MANAGER
  SENIOR_MANAGER
  DIRECTOR
  VP
  C_LEVEL
}

enum SeniorityLevel {
  INTERN
  JUNIOR
  MID_LEVEL
  SENIOR
  STAFF
  PRINCIPAL
  DISTINGUISHED
}

enum SkillImportance {
  CRITICAL      // Must have, deal-breaker
  REQUIRED      // Strong requirement
  PREFERRED     // Nice to have
  BONUS         // Extra credit
}